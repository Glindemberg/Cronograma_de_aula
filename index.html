<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docente V5 - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0f3d24; --accent: #218c74; --bg: #f4f7f6; --white: #fff; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        
        header { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .date-nav { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.2); border-radius: 8px; padding: 8px; margin-top: 10px; }
        .nav-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0 15px; }
        
        .tabs { display: flex; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 8px; color: rgba(255,255,255,0.7); cursor: pointer; border-radius: 16px; font-size: 0.85rem; }
        .tab.active { background: white; color: var(--primary); font-weight: bold; }
        
        .container { padding: 15px; display: none; }
        .container.active { display: block; }
        
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border-left: 5px solid var(--accent); }
        .card-header { background: #fff; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .turma-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-weight: bold; }
        .card-body { padding: 15px; }

        /* Infraestrutura */
        .infra-tags { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
        .tag.sala { background: #e8f8f5; color: var(--accent); font-weight: bold; }
        .tag.alert { background: #fadbd8; color: #c0392b; border: 1px solid #c0392b; }
        .tag.ok { background: #d4efdf; color: #1e8449; }
        .tag.aux { background: #fdebd0; color: #d35400; border: 1px solid #d35400; }

        .status-box { padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-top: 8px; }
        .box-memory { background: #fff3cd; color: #856404; border-left: 3px solid #ffeeba; margin-bottom: 5px;}
        .box-plan { background: #d1f2eb; color: #0e6251; border-left: 3px solid #a2d9ce; }
        .box-done { background: #d6eaf8; color: #21618c; border-left: 3px solid #a9cce3; }

        .btn-action { width: 100%; padding: 12px; background: #fff; border: none; border-top: 1px solid #eee; color: var(--accent); font-weight: bold; cursor: pointer; }
        
        /* Modal */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 10px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; }
        
        /* Ocultar campo OBS se necessário */
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; justify-content:space-between;"><b>Planner V5</b> <span id="loading-status"></span></div>
        <div class="date-nav">
            <button class="nav-btn" onclick="navegar(-1)"><i class="fas fa-chevron-left"></i></button>
            <span id="display-data" style="font-weight:bold">Hoje</span>
            <button class="nav-btn" onclick="navegar(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="mudarModo('dia')">Diário</div>
            <div class="tab" onclick="mudarModo('semana')">Planejar</div>
        </div>
    </header>

    <div id="view-dia" class="container active"></div>
    <div id="view-semana" class="container"></div>

    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-titulo" style="margin-top:0; color:var(--primary)">Registro</h3>
            <p id="modal-subtitulo" style="font-size:0.8rem; color:#666"></p>
            
            <label>Conteúdo / Atividade:</label>
            <textarea id="input-conteudo" rows="4"></textarea>
            
            <div id="div-obs">
                <label>Obs / Próxima Aula:</label>
                <textarea id="input-obs" rows="2"></textarea>
            </div>
            
            <input type="hidden" id="input-data">
            <input type="hidden" id="input-turma">
            <input type="hidden" id="input-tipo">

            <button onclick="salvar()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:5px; font-weight:bold">Salvar</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; padding:10px; background:none; border:none; color:#666; margin-top:5px">Cancelar</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzF00vCKZ95Wa4E80gVqRBAG-JXq52cXUqVZ2UIxbJZ-D77EgRAP1d52MurN17LSbKl/exec"; // Atualize a URL!

        let modo = 'dia';
        let offsetDia = 0;
        let offsetSemana = 0;

        function mudarModo(m) {
            modo = m;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            
            if (modo === 'dia') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('view-dia').classList.add('active');
                carregarDia();
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('view-semana').classList.add('active');
                carregarSemana();
            }
        }

        function navegar(dir) {
            if (modo === 'dia') { offsetDia += dir; carregarDia(); }
            else { offsetSemana += (dir * 7); carregarSemana(); }
        }

        function renderInfra(aula) {
            let html = `<div class="infra-tags"><div class="tag sala"><i class="fas fa-door-closed"></i> ${aula.sala}</div>`;
            
            if(aula.projetor) {
                let ruim = aula.projetor.toLowerCase().match(/ruim|alta|quebrado/);
                html += `<div class="tag ${ruim ? 'alert' : 'ok'}"><i class="fas fa-video"></i> ${aula.projetor}</div>`;
            }
            if(aula.auxiliar) {
                html += `<div class="tag aux"><i class="fas fa-hands-helping"></i> ${aula.auxiliar}</div>`;
            }
            return html + `</div>`;
        }

        function carregarDia() {
            document.getElementById('display-data').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            fetch(`${API_URL}?action=getDia&offset=${offsetDia}`).then(r => r.json()).then(json => {
                document.getElementById('display-data').innerText = json.dataExtenso;
                const div = document.getElementById('view-dia');
                div.innerHTML = "";
                
                if(json.aulas.length === 0) div.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Sem aulas.</p>";

                json.aulas.forEach(a => {
                    let status = "";
                    if (a.tipoHoje === "REALIZADO") status = `<div class="status-box box-done"><i class="fas fa-check"></i> <b>Feito:</b> ${a.conteudoHoje}</div>`;
                    else if (a.tipoHoje === "PLANEJADO") status = `<div class="status-box box-plan"><i class="fas fa-thumbtack"></i> <b>Planejado:</b> ${a.conteudoHoje}</div>`;
                    
                    div.innerHTML += `
                    <div class="card">
                        <div class="card-header"><span class="turma-badge">${a.turma}</span> <span>${a.inicio} - ${a.fim}</span></div>
                        <div class="card-body">
                            ${renderInfra(a)}
                            <div class="status-box box-memory"><i class="fas fa-history"></i> ${a.memoria}</div>
                            ${status}
                        </div>
                        <button class="btn-action" onclick="abrirModal('${a.turma}', '${a.dataFormatada}', 'REALIZADO', '${a.conteudoHoje||''}', '${a.obsHoje||''}')"><i class="fas fa-pen"></i> Registrar Aula</button>
                    </div>`;
                });
            });
        }

        function carregarSemana() {
            let txt = offsetSemana === 0 ? "Esta Semana" : (offsetSemana > 0 ? `+${offsetSemana/7} Semana` : `${offsetSemana/7} Semana`);
            document.getElementById('display-data').innerText = txt;
            document.getElementById('view-semana').innerHTML = '<p style="text-align:center"><i class="fas fa-spinner fa-spin"></i></p>';

            fetch(`${API_URL}?action=getSemana&offset=${offsetSemana}`).then(r => r.json()).then(json => {
                const div = document.getElementById('view-semana');
                div.innerHTML = "";
                
                json.forEach(dia => {
                    let htmlDia = `<div style="background:var(--accent); color:white; padding:5px 10px; border-radius:5px; margin-top:15px; font-size:0.9rem">${dia.data}</div>`;
                    
                    dia.aulas.forEach(a => {
                        let txtPlan = a.tipoHoje === "PLANEJADO" ? `<b>Planejado:</b> ${a.conteudoHoje}` : `<span style="color:#aaa">...</span>`;
                        
                        htmlDia += `
                        <div class="card" style="margin-top:10px; border-left:4px solid var(--primary)">
                            <div class="card-body" style="padding:10px">
                                <div style="display:flex; justify-content:space-between"><b>${a.turma}</b> <small>${a.inicio}</small></div>
                                ${renderInfra(a)}
                                <div style="font-size:0.85rem; margin-top:5px">${txtPlan}</div>
                            </div>
                            <button class="btn-action" onclick="abrirModal('${a.turma}', '${a.dataRaw}', 'PLANEJADO', '${a.conteudoHoje||''}', '')" style="padding:8px; font-size:0.8rem">Editar Planejamento</button>
                        </div>`;
                    });
                    div.innerHTML += htmlDia;
                });
            });
        }

        function abrirModal(turma, data, tipo, conteudo, obs) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-titulo').innerText = tipo === 'REALIZADO' ? "Registrar o Dia" : "Planejar Futuro";
            document.getElementById('modal-subtitulo').innerText = `${turma} - ${data}`;
            
            document.getElementById('input-turma').value = turma;
            document.getElementById('input-data').value = data;
            document.getElementById('input-tipo').value = tipo;
            document.getElementById('input-conteudo').value = conteudo !== "undefined" ? conteudo : "";
            
            // LOGICA NOVA: Se for Planejamento, esconde OBS
            if (tipo === 'PLANEJADO') {
                document.getElementById('div-obs').classList.add('hidden');
                document.getElementById('input-obs').value = "";
            } else {
                document.getElementById('div-obs').classList.remove('hidden');
                document.getElementById('input-obs').value = obs !== "undefined" ? obs : "";
            }
        }

        function salvar() {
            const btn = document.querySelector('button[onclick="salvar()"]');
            btn.innerText = "Salvando...";
            
            const payload = {
                turma: document.getElementById('input-turma').value,
                data: document.getElementById('input-data').value, // Formato "2026-06-02"
                tipo: document.getElementById('input-tipo').value,
                conteudo: document.getElementById('input-conteudo').value,
                obs: document.getElementById('input-obs').value
            };

            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(r => r.json())
            .then(res => {
                document.getElementById('modal').style.display = 'none';
                btn.innerText = "Salvar";
                if (modo === 'dia') carregarDia(); else carregarSemana();
            });
        }

        carregarDia();
    </script>
</body>
</html>
